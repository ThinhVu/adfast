"use strict";myApp.controller("trafficController",["$scope","authenticateService","trafficService","$cookies","siteService","$location",function(t,r,e,i,a,n){function o(r){t.siteInformation.siteGet=r.data.data}function c(r,e){for(var i=e/t.siteInformation.itemPerPage+1,a=r.data.data,n=0;n<a.length;n++){var o=(i-1)*t.siteInformation.itemPerPage+n;t.siteInformation.trafficGet[o]=a[n]}}function f(r){t.siteInformation.trafficGet=[],t.siteInformation.trafficGet=r.data.data;for(var e=t.siteInformation.trafficGet.length,i=t.siteInformation.count-e,a=0;a<i;a++)t.siteInformation.trafficGet.push({})}function m(r){t.siteInformation.trafficGet=[],validateErr(r,function(){})}t.currentCarrier="",t.currentTab=6,t.siteInformation={siteGet:[],trafficGet:[],userInformation:{},count:0,itemPerPage:$.urlParam("item")||"15"},t.currentSite="",t.currentPage=1,r.getUserInformation().then(function(r){t.$apply(function(){t.siteInformation.userInformation=r}),i.put("userInfo",JSON.stringify(r))}).catch(function(t){}),t.getTraffic=function(){function r(r){t.siteInformation.count=r.data.data,e.getTraffic(a,f,m)}var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";t.currentPage=1;var a=void 0,n=void 0;""==i.trim()?(a={start:(t.currentPage-1)*t.siteInformation.itemPerPage,action:"filter-all",count:t.siteInformation.itemPerPage,carrier:""==t.currentCarrier?void 0:t.currentCarrier},n={action:"count-all",carrier:""==t.currentCarrier?void 0:t.currentCarrier}):(a={start:0,action:"filter-site",site:i.trim(),count:t.siteInformation.itemPerPage,carrier:""==t.currentCarrier?void 0:t.currentCarrier},n={action:"count-site",site:i.trim(),carrier:""==t.currentCarrier?void 0:t.currentCarrier}),e.getTraffic(n,r,m)},t.getTraffic(),a.getSite(o,m),t.pageChangeHandler=function(r){var i=(r-1)*t.siteInformation.itemPerPage;if(!t.siteInformation.trafficGet[i]._id){var a={};a=""==t.currentSite.trim()?{start:i,action:"filter-all",count:t.siteInformation.itemPerPage,carrier:""==t.currentCarrier?void 0:t.currentCarrier}:{start:i,action:"filter-site",site:t.currentSite.trim(),count:t.siteInformation.itemPerPage,carrier:""==t.currentCarrier?void 0:t.currentCarrier},e.getTraffic(a,c,m)}},t.exportData=function(r){var i=void 0;if(r){var a=function(t){if(t){i="exportable-all";var r=void 0;e.getAllTraffic(function(t){r=t.data.data;var e=$("<table></table>"),a=$("#"+i).append(e),n=$("<thead><tr><th>STT</th><th>Số điện thoại</th><th>Nhà mạng</th><th>Địa điểm</th><th>Url trang</th><th>Truy cập gần nhất</th> <th>Số lượt truy cập</th> </tr></thead>");e.append(n);var o=$("<tbody></tbody>");o.appendTo(e);for(var c=0;c<r.length;c++){var f=r[c],m=$("<tr></tr>");m.appendTo(o),$("<td>"+(c+1)+"</td>").appendTo(m),$("<td>"+(null==f.phone?"":f.phone)+"</td>").appendTo(m),$("<td>"+(null==f.carrier?"":f.carrier)+"</td>").appendTo(m),$("<td>"+(null==f.city?"":f.city)+"</td>").appendTo(m),$("<td>"+(null==f._site.name?"":f._site.name)+"</td>").appendTo(m),$("<td>"+moment(f.requestTime).format("DD-MM-YYYY HH:mm:ss")+"</td>").appendTo(m),$("<td>"+(null==f.accessNumber?"":f.accessNumber)+"</td>").appendTo(m)}var u=moment().format("DD-MM-YYYY HH-mm-ss"),l=a.tableExport({formats:["xlsx"],fileName:"Export All_"+u});$(".btn.btn-default.xlsx").click(),AlertMessage("1","Vui lòng đợi giây lát trong lúc chúng tôi chuẩn bị file"),e.remove(),l.tableExport.remove()},m)}},n="<h4>Bạn có muốn xuất excel toàn bộ các bản ghi?</h4>";bootbox.confirm(n,a)}else{i="exportable";var o=(t.currentPage-1)*t.siteInformation.itemPerPage+1,c=t.currentPage*t.siteInformation.itemPerPage>t.siteInformation.count?t.siteInformation.count:t.currentPage*t.siteInformation.itemPerPage,f=moment().format("DD-MM-YYYY HH-mm-ss"),u=""==t.currentSite?"All Site":t.currentSite.trim(),l=""==t.currentCarrier?"All Carrier":t.currentCarrier,s="Report_"+u+"_"+l+"_"+o+"-"+c+"_"+f,d=$("#"+i).tableExport({formats:["xlsx"],fileName:s});$(".btn.btn-default.xlsx").click(),AlertMessage("1","Vui lòng đợi giây lát trong lúc chúng tôi chuẩn bị file"),d.tableExport.remove()}}}]);