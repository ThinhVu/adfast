#!/usr/bin/env node
"use strict";function browserName(t){return browserNameMap[t]||_.startCase(t)}function getOption(t,e){var i=_.isArray(e);return _.reduce(process.argv,function(e,s){return i?(s=optionToArray(t,s),_.isEmpty(s)?e:s):(s=optionToValue(t,s),null==s?e:s)},e)}function isJobId(t){return reJobId.test(t)}function logInline(t){var e=_.repeat(" ",_.size(prevLine));prevLine=t=_.truncate(t,{length:40}),process.stdout.write(t+e.slice(t.length)+"\r")}function logThrobber(){logInline("Please wait"+_.repeat(".",++waitCount%3+1))}function optionToArray(t,e){return _.compact(_.invokeMap((optionToValue(t,e)||"").split(/, */),"trim"))}function optionToValue(t,e){var i=e.match(RegExp("^"+t+"(?:=([\\s\\S]+))?$"));return i&&(i=_.get(i,1),i=!i||_.trim(i)),"false"!==i&&(i||void 0)}function onGenericRestart(){this.restarting=!1,this.emit("restart"),this.start()}function onGenericStop(t){this.running=this.stopping=!1,this.emit("stop",t)}function onJobRemove(t,e,i){this.id=this.taskId=this.url=null,this.removing=!1,this.emit("remove")}function onJobReset(){this.attempts=0,this.failed=this.resetting=!1,this._pollerId=this.id=this.result=this.taskId=this.url=null,this.emit("reset")}function onJobStart(t,e,i){if(this.starting=!1,!this.stopping){var s=_.get(e,"statusCode"),r=_.first(_.get(i,"js tests"));if(t||!r||200!=s){if(this.attempts<this.retries)return void this.restart();var n="unavailable",o=_.isObject(i)?"\n"+JSON.stringify(i):n,a=_.isFinite(s)?s:n;return logInline(),console.error("Failed to start job; status: %s, body: %s",a,o),t&&console.error(t),this.failed=!0,void this.emit("complete")}this.running=!0,this.taskId=r,this.timestamp=_.now(),this.emit("start"),this.status()}}function onJobStatus(t,e,i){if(this.checking=!1,this.running&&!this.stopping){var s=_.get(i,"completed",!1),r=_.first(_.get(i,"js tests")),n=(_.now()-this.timestamp)/1e3,o=_.get(r,"job_id",null),a=_.get(r,"result",null),u=_.get(r,"status",""),l=_.get(r,"url",null),h=n>=queueTimeout&&!_.includes(u,"in progress"),p=this.options,c=p.platforms[0];if(_.isObject(a))var d=_.get(a,"message");else"string"==typeof a&&(d=a),a=null;if(isJobId(o)?(this.id=o,this.result=a,this.url=l):s=!1,this.emit("status",u),!s&&!h)return void(this._pollerId=_.delay(_.bind(this.status,this),1e3*this.statusInterval));var m=browserName(c[1])+" "+c[2]+" on "+_.startCase(c[0]),g=!a||!a.passed||reError.test(d)||reError.test(u),f=_.get(a,"failed"),v=p.name+":",b=this.tunnel;if(g||f){if(g&&this.attempts<this.retries)return void this.restart();var I="See "+l+" for details.";if(this.failed=!0,logInline(),f)console.error(v+" %s "+chalk.red("failed")+" %d test"+(f>1?"s":"")+". %s",m,f,I);else{if(b.attempts<b.retries)return void b.restart();void 0===d&&(d="Results are unavailable. "+I),console.error(v,m,chalk.red("failed")+";",d)}}else logInline(),console.log(v,m,chalk.green("passed"));this.running=!1,this.emit("complete")}}function onTunnelStart(t){if(this.starting=!1,this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null),!t){if(this.attempts<this.retries)return void this.restart();logInline(),console.error("Failed to open Sauce Connect tunnel"),process.exit(2)}logInline(),console.log("Sauce Connect tunnel opened");var e=this.jobs;push.apply(e.queue,e.all),this.running=!0,this.emit("start"),console.log("Starting jobs..."),this.dequeue()}function Job(t){EventEmitter.call(this),this.options={},_.merge(this,t),_.defaults(this.options,_.cloneDeep(jobOptions)),this.attempts=0,this.checking=this.failed=this.removing=this.resetting=this.restarting=this.running=this.starting=this.stopping=!1,this._pollerId=this.id=this.result=this.taskId=this.url=null}function Tunnel(t){EventEmitter.call(this),_.merge(this,t);var e=[],i=[],s=_.map(this.platforms,_.bind(function(t){return new Job(_.merge({user:this.user,pass:this.pass,tunnel:this,options:{platforms:[t]}},this.job))},this)),r=0,n=[],o=!0,a=s.length,u=this;_.invokeMap(s,"on","complete",function(){return _.pull(e,this),o&&(o=!this.failed),++r==a?void u.stop(_.partial(u.emit,"complete",o)):void u.dequeue()}),_.invokeMap(s,"on","restart",function(){_.includes(n,this)||n.push(this);var t=Math.min(s.length,_.isFinite(throttled)?throttled:3);u.attempts<u.retries&&e.length>=t&&_.isEmpty(_.difference(e,n))&&u.restart()}),this.on("restart",function(){r=0,o=!0,n.length=0}),this._timeoutId=null,this.attempts=0,this.restarting=this.running=this.starting=this.stopping=!1,this.jobs={active:e,all:s,queue:i},this.connection=new SauceTunnel(this.user,this.pass,this.id,this.tunneled,["-P","0"])}var env=process.env,EventEmitter=require("events").EventEmitter,http=require("http"),path=require("path"),url=require("url"),util=require("util"),_=require("../lodash.js"),chalk=require("chalk"),ecstatic=require("ecstatic"),request=require("request"),SauceTunnel=require("sauce-tunnel"),accessKey=env.SAUCE_ACCESS_KEY,username=env.SAUCE_USERNAME,maxJobRetries=3,maxTunnelRetries=3,mount=ecstatic({cache:"no-cache",root:process.cwd()}),ports=[80,443,888,2e3,2001,2020,2109,2222,2310,3e3,3001,3030,3210,3333,4e3,4001,4040,4321,4502,4503,4567,5e3,5001,5050,5555,5432,6e3,6001,6060,6666,6543,7e3,7070,7774,7777,8e3,8001,8003,8031,8080,8081,8765,8777,8888,9e3,9001,9080,9090,9876,9877,9999,49221,55001],prevLine="",push=Array.prototype.push,reError=/(?:\be|E)rror\b/,reJobId=/^[a-z0-9]{32}$/,throbberDelay=500,waitCount=-1,advisor=getOption("advisor",!1),build=getOption("build",(env.TRAVIS_COMMIT||"").slice(0,10)),commandTimeout=getOption("commandTimeout",90),compatMode=getOption("compatMode",null),customData=Function("return {"+getOption("customData","").replace(/^\{|}$/g,"")+"}")(),deviceOrientation=getOption("deviceOrientation","portrait"),framework=getOption("framework","qunit"),idleTimeout=getOption("idleTimeout",60),jobName=getOption("name","unit tests"),maxDuration=getOption("maxDuration",180),port=ports[Math.min(_.sortedIndex(ports,getOption("port",9001)),ports.length-1)],publicAccess=getOption("public",!0),queueTimeout=getOption("queueTimeout",240),recordVideo=getOption("recordVideo",!0),recordScreenshots=getOption("recordScreenshots",!1),runner=getOption("runner","test/index.html").replace(/^\W+/,""),runnerUrl=getOption("runnerUrl","http://localhost:"+port+"/"+runner),statusInterval=getOption("statusInterval",5),tags=getOption("tags",[]),throttled=getOption("throttled",10),tunneled=getOption("tunneled",!0),tunnelId=getOption("tunnelId","tunnel_"+(env.TRAVIS_JOB_ID||0)),tunnelTimeout=getOption("tunnelTimeout",120),videoUploadOnPass=getOption("videoUploadOnPass",!1),browserNameMap={googlechrome:"Chrome",iehta:"Internet Explorer",ipad:"iPad",iphone:"iPhone",microsoftedge:"Edge"},platforms=[["Linux","android","5.1"],["Windows 10","chrome","54"],["Windows 10","chrome","53"],["Windows 10","firefox","50"],["Windows 10","firefox","49"],["Windows 10","microsoftedge","14"],["Windows 10","internet explorer","11"],["Windows 8","internet explorer","10"],["Windows 7","internet explorer","9"],["macOS 10.12","safari","10"],["OS X 10.11","safari","9"]],isAMD=_.includes(tags,"amd"),isBackbone=_.includes(tags,"backbone"),isModern=_.includes(tags,"modern");compatMode&&(platforms=[["Windows 10","internet explorer","11"],["Windows 8","internet explorer","10"],["Windows 7","internet explorer","9"],["Windows 7","internet explorer","8"]]),isAMD&&(platforms=_.filter(platforms,function(t){var e=browserName(t[1]),i=+t[2];switch(e){case"Android":return i>=4.4;case"Opera":return i>=10}return!0})),isBackbone&&(platforms=_.filter(platforms,function(t){var e=browserName(t[1]),i=+t[2];switch(e){case"Firefox":return i>=4;case"Internet Explorer":return i>=7;case"iPad":return i>=5;case"Opera":return i>=12}return!0})),isModern&&(platforms=_.filter(platforms,function(t){var e=browserName(t[1]),i=+t[2];switch(e){case"Android":return i>=4.1;case"Firefox":return i>=10;case"Internet Explorer":return i>=9;case"iPad":return i>=6;case"Opera":return i>=12;case"Safari":return i>=6}return!0}));var jobOptions={build:build,"command-timeout":commandTimeout,"custom-data":customData,"device-orientation":deviceOrientation,framework:framework,"idle-timeout":idleTimeout,"max-duration":maxDuration,name:jobName,public:publicAccess,platforms:platforms,"record-screenshots":recordScreenshots,"record-video":recordVideo,"sauce-advisor":advisor,tags:tags,url:runnerUrl,"video-upload-on-pass":videoUploadOnPass};publicAccess===!0&&(jobOptions.public="public"),tunneled&&(jobOptions["tunnel-identifier"]=tunnelId),util.inherits(Job,EventEmitter),Job.prototype.remove=function(t){return this.once("remove",_.iteratee(t)),this.removing?this:(this.removing=!0,this.stop(function(){var t=_.bind(onJobRemove,this);return this.id?void request.del(_.template("https://saucelabs.com/rest/v1/${user}/jobs/${id}")(this),{auth:{user:this.user,pass:this.pass}},t):void _.defer(t)}))},Job.prototype.reset=function(t){return this.once("reset",_.iteratee(t)),this.resetting?this:(this.resetting=!0,this.remove(onJobReset))},Job.prototype.restart=function(t){if(this.once("restart",_.iteratee(t)),this.restarting)return this;this.restarting=!0;var e=this.options,i=e.platforms[0],s=browserName(i[1])+" "+i[2]+" on "+_.startCase(i[0]),r=e.name+":";return logInline(),console.log("%s %s restart %d of %d",r,s,++this.attempts,this.retries),this.remove(onGenericRestart)},Job.prototype.start=function(t){return this.once("start",_.iteratee(t)),this.starting||this.running?this:(this.starting=!0,request.post(_.template("https://saucelabs.com/rest/v1/${user}/js-tests")(this),{auth:{user:this.user,pass:this.pass},json:this.options},_.bind(onJobStart,this)),this)},Job.prototype.status=function(t){return this.once("status",_.iteratee(t)),this.checking||this.removing||this.resetting||this.restarting||this.starting||this.stopping?this:(this._pollerId=null,this.checking=!0,request.post(_.template("https://saucelabs.com/rest/v1/${user}/js-tests/status")(this),{auth:{user:this.user,pass:this.pass},json:{"js tests":[this.taskId]}},_.bind(onJobStatus,this)),this)},Job.prototype.stop=function(t){if(this.once("stop",_.iteratee(t)),this.stopping)return this;this.stopping=!0,this._pollerId&&(clearTimeout(this._pollerId),this._pollerId=null,this.checking=!1);var e=_.bind(onGenericStop,this);return this.running&&this.id?(request.put(_.template("https://saucelabs.com/rest/v1/${user}/jobs/${id}/stop")(this),{auth:{user:this.user,pass:this.pass}},e),this):(_.defer(e),this)},util.inherits(Tunnel,EventEmitter),Tunnel.prototype.restart=function(t){if(this.once("restart",_.iteratee(t)),this.restarting)return this;this.restarting=!0,logInline(),console.log("Tunnel %s: restart %d of %d",this.id,++this.attempts,this.retries);var e=this.jobs,i=e.active,s=e.all,r=_.after(s.length,_.bind(this.stop,this,onGenericRestart)),n=_.after(i.length,_.partial(_.invokeMap,s,"reset",r));return _.isEmpty(i)&&_.defer(n),_.isEmpty(s)&&_.defer(r),_.invokeMap(i,"stop",function(){_.pull(i,this),n()}),this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null),this},Tunnel.prototype.start=function(t){if(this.once("start",_.iteratee(t)),this.starting||this.running)return this;this.starting=!0,logInline(),console.log("Opening Sauce Connect tunnel...");var e=_.bind(onTunnelStart,this);return this.timeout&&(this._timeoutId=_.delay(e,1e3*this.timeout,!1)),this.connection.start(e),this},Tunnel.prototype.dequeue=function(){for(var t=0,e=this.jobs,i=e.active,s=e.queue,r=this.throttled;s.length&&i.length<r;){var n=s.shift();i.push(n),_.delay(_.bind(n.start,n),1e3*++t)}return this},Tunnel.prototype.stop=function(t){if(this.once("stop",_.iteratee(t)),this.stopping)return this;this.stopping=!0,logInline(),console.log("Shutting down Sauce Connect tunnel...");var e=this.jobs,i=e.active,s=_.after(i.length,_.bind(function(){var t=_.bind(onGenericStop,this);this.running?this.connection.stop(t):t()},this));return e.queue.length=0,_.isEmpty(i)&&_.defer(s),_.invokeMap(i,"stop",function(){_.pull(i,this),s()}),this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=null),this},process.on("SIGINT",function(){logInline(),process.exit()}),http.createServer(function(t,e){compatMode&&".html"==path.extname(url.parse(t.url).pathname)&&e.setHeader("X-UA-Compatible","IE="+compatMode),mount(t,e)}).listen(port);var tunnel=new Tunnel({user:username,pass:accessKey,id:tunnelId,job:{retries:maxJobRetries,statusInterval:statusInterval},platforms:platforms,retries:maxTunnelRetries,throttled:throttled,tunneled:tunneled,timeout:tunnelTimeout});tunnel.on("complete",function(t){process.exit(t?0:1)}),tunnel.start(),setInterval(logThrobber,throbberDelay);